<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVSE Control</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
        /* Ensure the chart container scales with the screen size */
        #chart {
            width: 100%;
            height: 80vh;
            /* Use 80% of the viewport height */
            max-height: 600px;
            /* Limit maximum height for larger screens */
        }

        .nav-links {
            margin-bottom: 20px;
        }

        .nav-links a {
            color: #0066cc;
            text-decoration: none;
            margin-right: 15px;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .status-item .separator {
            margin: 0 20px;
            color: #dee2e6;
        }

        .status-info {
            display: inline-block;
            margin-right: 20px;
        }
    </style>
</head>

<body>
    <h1>EVSE Control Interface</h1>
    <div class="nav-links">
        <a href="{{ url_for('schedule') }}">Schedule Events â†’</a>
    </div>

    <div class="status-panel">
        <div class="status-item">
            <span class="status-info">
                <strong>Current State:</strong> <span id="current-state">Loading...</span>
            </span>
            <span class="separator">|</span>
            <span class="status-info">
                <strong>State of Charge:</strong> <span id="soc">Loading...</span>
            </span>
        </div>
        <div class="status-item">
            <strong>Next Scheduled Event:</strong> <span id="next-event">Loading...</span>
        </div>
    </div>

    <button onclick="sendCommand('octgo')">Select and start Octopus Go</button>
    <button onclick="sendCommand('cosy')">Select and start Cosy Octopus</button>
    <button onclick="sendCommand('pause')">Pause</button>
    <button onclick="sendCommand('charge')">Charge</button>
    <button onclick="sendCommand('discharge')">Discharge</button>

    <div class="svg-button-container">
        <button class="svg-button" title="Pause to remove plug">
            <img src="{{ url_for('static', filename='images/Pause to remove plug.svg') }}" alt="Pause to remove plug">
        </button>
        <button class="svg-button" title="Solar only charging">
            <img src="{{ url_for('static', filename='images/Solar only charging.svg') }}" alt="Solar only charging">
        </button>
    </div>

    <h1>EVSE Power History</h1>
    <div id="chart" style="width:100%;height:600px;"></div>

    <style>
        .status-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .status-item {
            margin: 10px 0;
        }

        .status-item strong {
            color: #495057;
        }

        .svg-button-container {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .svg-button {
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .svg-button:hover {
            background-color: #e9ecef;
            transform: scale(1.05);
        }

        .svg-button:active {
            transform: scale(0.95);
        }

        .svg-button img {
            height: 24px;
            width: auto;
        }
    </style>

    <script>
        async function fetchHistory() {
            const response = await fetch('/api/history');
            return await response.json();
        }

        function isMobile() {
            return window.innerWidth <= 768; // Adjust the threshold as needed
        }

        function getLayout() {
            const isMobileDevice = isMobile();
            return {
                title: 'Power and SoC History',
                xaxis: {
                    title: 'Time',
                    tickmode: 'auto',
                    nticks: 10,
                    titlefont: { size: isMobileDevice ? 12 : 14 }, // Smaller font for mobile
                    tickfont: { size: isMobileDevice ? 10 : 12 }
                },
                yaxis: {
                    title: 'Power (W)',
                    titlefont: { size: isMobileDevice ? 12 : 14 },
                    tickfont: { size: isMobileDevice ? 10 : 12 }
                },
                yaxis2: {
                    title: 'SoC (%)',
                    overlaying: 'y',
                    side: 'right',
                    titlefont: { size: isMobileDevice ? 12 : 14 },
                    tickfont: { size: isMobileDevice ? 10 : 12 }
                },
                responsive: true,
                autosize: true,
                margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
            };
        }

        function updateChart() {
            fetchHistory().then(data => {
                const timestamps = data.timestamps.map(t => new Date(t * 1000).toLocaleTimeString());
                const gridPower = data.grid_power;
                const evsePower = data.evse_power;
                const heatPumpPower = data.heat_pump_power;
                const solarPower = data.solar_power;

                // Calculate home power consumption
                const homePower = gridPower.map((grid, index) => grid - evsePower[index] - heatPumpPower[index] - solarPower[index]);

                // Update the chart
                const chartData = [
                    { x: timestamps, y: gridPower, name: 'Grid pwr (W)', type: 'scatter' },
                    { x: timestamps, y: evsePower, name: 'EVSE pwr (W)', type: 'scatter' },
                    { x: timestamps, y: heatPumpPower, name: 'HP pwr (W)', type: 'scatter' },
                    { x: timestamps, y: solarPower, name: 'Solar pwr (W)', type: 'scatter' },
                    { x: timestamps, y: homePower, name: 'Home pwr (W)', type: 'scatter' }
                ];

                const layout = {
                    title: 'Power History',
                    xaxis: {
                        title: 'Time',
                        tickmode: 'auto',
                        nticks: 10  // Show a maximum of 10 ticks
                    },
                    yaxis: { title: 'Power (W)' },
                    responsive: true, // Make the chart responsive
                    autosize: true,  // Automatically adjust the chart size
                    margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 } // Adjust margins for better fit
                };

                const config = {
                    responsive: true // Ensure the chart is responsive
                };

                Plotly.newPlot('chart', chartData, layout, config);

                // Update the latest SoC and home power consumption
                const latestSoc = data.soc[data.soc.length - 1];
                document.getElementById('soc').textContent = `${latestSoc}%`;
            });
        }

        // Update the chart every second
        setInterval(updateChart, 1000);
        updateChart(); // Initial call

        // Adjust layout on window resize
        window.addEventListener('resize', () => {
            Plotly.relayout('chart', getLayout());
        });

        async function sendCommand(command) {
            try {
                const response = await fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to send command');
                }

                // Immediately update the status after sending a command
                updateStatus();
            } catch (error) {
                console.error('Error sending command:', error);
                alert('Failed to send command: ' + error.message);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update current state
                const stateElement = document.getElementById('current-state');
                stateElement.textContent = data.current_state.replace(/_/g, ' ');

                // Update next event
                const nextEventElement = document.getElementById('next-event');
                if (data.next_event) {
                    const eventTime = new Date(data.next_event.timestamp);
                    nextEventElement.textContent = `${data.next_event.state} at ${eventTime.toLocaleString()}`;
                } else {
                    nextEventElement.textContent = 'No events scheduled';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
        updateStatus(); // Initial call
    </script>
</body>

</html>